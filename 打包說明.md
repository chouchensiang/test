# 化學品相容性查詢系統 - EXE 打包說明

## 1. 需要的套件

| 套件 | 用途 |
|------|------|
| flask | Web 伺服器 |
| flask-cors | 跨域請求支援 |
| pandas | 資料處理 |
| openpyxl | Excel 讀寫 |
| pyinstaller | EXE 打包 |

---

## 2. 安裝套件（在打包用的電腦）

### 方式 A：有網路的電腦（推薦）

```powershell
pip install flask flask-cors pandas openpyxl pyinstaller
```

打包完成後，EXE 可以直接拿到任何電腦使用，**不需要安裝 Python**。

---

### 方式 B：離線電腦打包（較複雜）

如果必須在離線電腦打包，才需要以下步驟：

#### Step 1: 在有網路的電腦下載套件（Linux 環境下載 Windows 套件）

```bash
# 建立資料夾存放套件
mkdir -p ~/packages

# 下載 Windows 64-bit 套件（含所有依賴）
pip download \
  --platform win_amd64 \
  --python-version 3.11 \
  --only-binary :all: \
  --dest ~/packages \
  flask flask-cors pandas openpyxl pyinstaller numpy pytz python-dateutil

# 有些純 Python 套件需要不指定平台下載
pip download \
  --no-binary :all: \
  --dest ~/packages \
  flask flask-cors openpyxl et-xmlfile
```

> **注意**：`--python-version` 要對應目標電腦的 Python 版本（如 3.10、3.11、3.12）

#### Step 2: 複製到離線 Windows 電腦

把整個 `packages` 資料夾複製到 Windows 電腦，例如 `C:\packages`

#### Step 3: 在離線 Windows 電腦建立虛擬環境

```powershell
# 切換到專案資料夾
cd C:\Users\user\Downloads\test_1124\crw4_automation\EXE

# 建立虛擬環境
python -m venv venv

# 啟動虛擬環境
.\venv\Scripts\Activate.ps1
```

> 如果 PowerShell 執行原則限制，改用：`.\venv\Scripts\activate.bat`（在 CMD）  
> 或先執行：`Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`

#### Step 4: 在虛擬環境中離線安裝套件

```powershell
# 確認已在虛擬環境中（提示符會顯示 (venv)）
pip install --no-index --find-links=C:\packages flask flask-cors pandas openpyxl pyinstaller
```

#### Step 5: 確認安裝成功

```powershell
pip list
```

應該會看到 flask, pandas, openpyxl, pyinstaller 等套件。

---

## 3. 打包指令

### 切換到 EXE 資料夾

```powershell
cd C:\Users\user\Downloads\test_1124\crw4_automation\EXE
```

### 打包成單一 EXE 檔案

```powershell
pyinstaller --name ChemCompatibility --onefile --windowed --noconfirm --clean --add-data "web.html;." --hidden-import flask --hidden-import flask_cors --hidden-import pandas --hidden-import openpyxl --hidden-import sqlite3 app.py
```

### 參數說明

| 參數 | 說明 |
|------|------|
| `--name ChemCompatibility` | EXE 名稱 |
| `--onefile` | 打包成單一檔案 |
| `--windowed` | 不顯示命令列視窗 |
| `--noconfirm` | 覆蓋舊檔案 |
| `--clean` | 清理暫存 |
| `--add-data "web.html;."` | 打包 web.html |
| `--hidden-import xxx` | 加入隱藏模組 |

---

## 4. 打包後結構

```
dist/
  ChemCompatibility.exe    # 單一執行檔（約 50-80MB）
```

---

## 5. 使用方式

1. 建立 `reports` 資料夾（與 EXE 同目錄）
2. 把 `ChemCompatibility.db` 放入 `reports` 資料夾
3. 雙擊 `ChemCompatibility.exe`

```
ChemCompatibility.exe
reports/
  ChemCompatibility.db     # 使用者自己放入
```

---

## 6. 常見問題

### Q: 找不到 sqlite3.dll

把 Conda 環境中的 DLL 複製到 EXE 同目錄：

```
C:\Users\user\.conda\envs\exe\Library\bin\sqlite3.dll
```

### Q: 打包很慢

`--onefile` 需要壓縮所有檔案，可能需要 5-10 分鐘。

### Q: 啟動很慢

`--onefile` 每次啟動都要解壓縮，首次啟動可能需要 10-20 秒。

如果想要啟動快一點，改用 `--onedir`：

```powershell
pyinstaller --name ChemCompatibility --onedir --windowed --noconfirm --clean --add-data "web.html;." --hidden-import flask --hidden-import flask_cors --hidden-import pandas --hidden-import openpyxl --hidden-import sqlite3 app.py
```

這樣會產生一個資料夾，啟動較快但檔案較多。
